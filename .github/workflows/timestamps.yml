name: Update Issue Timestamps

on:
  issues:
    types:
      - closed
      - labeled

permissions:
  issues: write  # Needed to access issue metadata
  repository-projects: write  # Needed to update custom fields

env:
  PROJECT_ID: "5"  # Replace with your GitHub project ID
  FIELD_START_ID: "PVTF_lAHOAAK3U84A1tT_zgrImXs"  # Replace with the actual field ID
  FIELD_END_ID: "PVTF_lAHOAAK3U84A1tT_zgrIm1k"  # Replace with the actual field ID
  LABEL_NAME: "this sprint"

jobs:
  update-timestamps:
    runs-on: ubuntu-latest
    steps:
      - name: Set end timestamp when issue is closed
        if: github.event.action == 'closed'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          ISSUE_ID=$(jq -r '.issue.node_id' <<< '${{ toJson(github.event) }}')

          curl -X POST -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               -H "Content-Type: application/json" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/graphql \
               -d @- <<EOF
          {
            "query": "mutation { updateProjectV2ItemFieldValue(input: { projectId: \"$PROJECT_ID\", itemId: \"$ISSUE_ID\", fieldId: \"$FIELD_END_ID\", value: { text: \"$TIMESTAMP\" } }) { clientMutationId } }"
          }
          EOF

      - name: Set start timestamp when issue is labeled
        if: github.event.action == 'labeled' && github.event.label.name == env.LABEL_NAME
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          ISSUE_ID=$(jq -r '.issue.node_id' <<< '${{ toJson(github.event) }}')

          curl -X POST -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               -H "Content-Type: application/json" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/graphql \
               -d @- <<EOF
          {
            "query": "mutation { updateProjectV2ItemFieldValue(input: { projectId: \"$PROJECT_ID\", itemId: \"$ISSUE_ID\", fieldId: \"$FIELD_START_ID\", value: { text: \"$TIMESTAMP\" } }) { clientMutationId } }"
          }
          EOF
